name: 1.0.$(Rev:r)
trigger:
  branches:
    include:
    - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'a9e35dc1-0272-4f15-a968-88b81d71df31'
  imageRepository: 'simulation/demo-api'
  containerRegistry: 'rutzscocr.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Demo.API/Dockerfile'
  tag: '$(Build.BuildNumber)'

steps:

- task: Docker@2
  displayName: Build and push an image to container registry
  inputs:
    command: buildAndPush
    repository: $(imageRepository)
    dockerfile: $(dockerfilePath)
    containerRegistry: $(dockerRegistryServiceConnection)
    tags: $(tag)
    
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'Infrastructure'
    artifact: 'Infrastructure'
    publishLocation: 'pipeline'